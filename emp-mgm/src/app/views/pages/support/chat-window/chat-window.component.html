<div class="row chat-wrapper">
    <div class="col-md-12">
        <div class="card">
            <div class="card-body">
                <div class="row position-relative">
                    <div class="col-lg-4 chat-aside border-lg-right">
                        <div class="aside-content">
                            <div class="aside-header">
                                <!-- <div class="d-flex justify-content-between align-items-center pb-2 mb-2">
                                    <div class="d-flex align-items-center">
                                        <figure class="mr-2 mb-0">
                                            <img src="https://via.placeholder.com/43x43" class="img-sm rounded-circle"
                                                alt="profile">
                                            <div class="status online"></div>
                                        </figure>
                                        <div>
                                            <h6>Amiah Burton</h6>
                                            <p class="text-muted tx-13">Software Developer</p>
                                        </div>
                                    </div>
                                    <div class="dropdown" ngbDropdown>
                                        <button class="btn p-0 no-dropdown-toggle-icon" type="button"
                                            id="dropdownMenuButton" ngbDropdownToggle>
                                            <i class="feather icon-settings icon-md text-muted pb-3px"
                                                ngbTooltip="Settings"></i>
                                        </button>
                                        <div class="dropdown-menu" aria-labelledby="dropdownMenuButton" ngbDropdownMenu>
                                            <a class="dropdown-item d-flex align-items-center" href=""
                                                (click)="false"><i class="feather icon-eye icon-xs mr-2"></i> <span
                                                    class="">View Profile</span></a>
                                            <a class="dropdown-item d-flex align-items-center" href=""
                                                (click)="false"><i class="feather icon-edit-2 icon-xs mr-2"></i> <span
                                                    class="">Edit Profile</span></a>
                                            <a class="dropdown-item d-flex align-items-center" href=""
                                                (click)="false"><i class="feather icon-aperture icon-xs mr-2"></i> <span
                                                    class="">Add status</span></a>
                                            <a class="dropdown-item d-flex align-items-center" href=""
                                                (click)="false"><i class="feather icon-settings icon-xs mr-2"></i> <span
                                                    class="">Settings</span></a>
                                        </div>
                                    </div>
                                </div> -->
                                <!-- <form class="search-form">
                                    <div class="input-group border rounded-sm">
                                        <div class="input-group-prepend">
                                            <div class="input-group-text border-0 rounded-sm">
                                                <i class="feather icon-search icon-sm cursor-pointer"></i>
                                            </div>
                                        </div>
                                        <input type="text" class="form-control  border-0 rounded-sm" id="searchForm"
                                            placeholder="Search here...">
                                    </div>
                                </form> -->
                            </div>
                            <div class="aside-body" style="height: calc(100vh - 230px);">
                                <ul ngbNav #defaultNav="ngbNav" [(activeId)]="defaultNavActiveId"
                                    class="nav-tabs mt-3 nav-fill">
                                    <li [ngbNavItem]="1">
                                        <a ngbNavLink>
                                            <div
                                                class="d-flex flex-row flex-lg-column flex-xl-row align-items-center justify-content-center">
                                                <i
                                                    class="feather icon-message-square icon-xs mr-sm-2 mr-lg-0 mr-xl-2 mb-md-1 mb-xl-0"></i>
                                                <p class="d-none d-sm-block">Active</p>
                                            </div>
                                        </a>
                                        <ng-template ngbNavContent>
                                            <div class="ps" [perfectScrollbar]>
                                                <p class="text-muted mb-1">Recent Active chats</p>
                                                <ul class="list-unstyled chat-list px-1">
                                                    <li class="chat-item pr-1"
                                                        *ngFor="let conversation of activeconversations"
                                                        (click)="backToChatList()">
                                                        <a (click)="selectChat(conversation)"
                                                            class="d-flex align-items-center">
                                                            <figure class="mb-0 mr-2">
                                                                <img [src]="sanitizeimage(conversation.profile_pic)"
                                                                    class="img-xs rounded-circle" alt="user">
                                                                <div class="status online"></div>
                                                            </figure>
                                                            <div
                                                                class="d-flex justify-content-between flex-grow border-bottom">
                                                                <div>
                                                                    <p class="text-body font-weight-bold">
                                                                        {{conversation.user_name}}</p>
                                                                    <div class="d-flex align-items-center"
                                                                        *ngIf="!hastyping(conversation._id) && conversation.is_image">
                                                                        <i
                                                                            class="feather icon-image text-muted icon-sm mb-2px"></i>
                                                                        <p class="text-muted ml-1">Photo</p>
                                                                    </div>
                                                                    <p class="text-muted tx-13"
                                                                        *ngIf="!hastyping(conversation._id) && !conversation.is_image">
                                                                        {{msgdisp(conversation.last_message)}}</p>
                                                                    <p class="text-success font-weight-medium tx-13"
                                                                        *ngIf="hastyping(conversation._id)">typing...
                                                                    </p>
                                                                </div>
                                                                <div class="d-flex flex-column align-items-end">
                                                                    <p class="text-muted tx-13 mb-1">
                                                                        {{chattime(conversation.last_message_time)}}</p>
                                                                    <!-- UNREAD MESSAGE COUNT -->
                                                                    <div *ngIf="isunread(conversation._id)"
                                                                        class="badge badge-pill badge-primary ml-auto">
                                                                        {{conversation.agent_unread_count}}</div>
                                                                </div>
                                                            </div>
                                                        </a>
                                                    </li>
                                                </ul>
                                            </div>
                                        </ng-template>
                                    </li> <!-- End chat tab-->
                                    <li [ngbNavItem]="2">
                                        <a ngbNavLink>
                                            <div
                                                class="d-flex flex-row flex-lg-column flex-xl-row align-items-center justify-content-center">
                                                <i *ngIf="queuedconversations?.length==0"
                                                    class="feather icon-clock icon-xs mr-sm-2 mr-lg-0 mr-xl-2 mb-md-1 mb-xl-0"></i>
                                                <span *ngIf="queuedconversations?.length>0"
                                                    class="badge badge-pill badge-primary ml-auto">{{queuedconversations?.length}}</span>
                                                <p class="d-none d-sm-block">Queue </p>
                                            </div>
                                        </a>
                                        <ng-template ngbNavContent>
                                            <div class="ps" [perfectScrollbar]>
                                                <p class="text-muted mb-1">Chats in Queue</p>
                                                <ul class="list-unstyled chat-list px-1">
                                                    <li class="chat-item pr-1"
                                                        *ngFor="let conversation of queuedconversations; let i = index">
                                                        <a (click)="selectqueuedChat(conversation,i)"
                                                            class="d-flex align-items-center">
                                                            <figure class="mb-0 mr-2">
                                                                <img [src]="sanitizeimage(conversation.profile_pic)"
                                                                    class="img-xs rounded-circle" alt="user">
                                                                <div class="status online"></div>
                                                            </figure>
                                                            <div
                                                                class="d-flex justify-content-between flex-grow border-bottom">
                                                                <div>
                                                                    <p class="text-body font-weight-bold">
                                                                        {{conversation.user_name}}
                                                                        <span
                                                                            class="badge badge-pill badge-success ml-2">
                                                                            {{conversation.category}}</span>
                                                                    </p>
                                                                    <div class="d-flex align-items-center"
                                                                        *ngIf="conversation.is_image">
                                                                        <i
                                                                            class="feather icon-image text-muted icon-sm mb-2px"></i>
                                                                        <p class="text-muted ml-1">Photo</p>
                                                                    </div>
                                                                    <p class="text-muted tx-13"
                                                                        *ngIf="!conversation.is_image">
                                                                        {{msgdisp(conversation.last_message)}}</p>
                                                                </div>
                                                                <div class="d-flex flex-column align-items-end">
                                                                    <p class="text-muted tx-13 mb-1">
                                                                        {{chattime(conversation.last_message_time)}}</p>
                                                                    <!-- UNREAD MESSAGE COUNT -->
                                                                    <div *ngIf="isunread(conversation._id)"
                                                                        class="badge badge-pill badge-primary ml-auto">
                                                                        {{conversation.agent_unread_count}}</div>
                                                                </div>
                                                            </div>
                                                        </a>
                                                    </li>
                                                </ul>
                                            </div>
                                        </ng-template>
                                    </li> <!-- End calls tab-->
                                    <li [ngbNavItem]="3">
                                        <a ngbNavLink (click)="getconvhistory()">
                                            <div
                                                class="d-flex flex-row flex-lg-column flex-xl-row align-items-center justify-content-center">
                                                <i
                                                    class="feather icon-message-circle icon-xs mr-sm-2 mr-lg-0 mr-xl-2 mb-md-1 mb-xl-0"></i>
                                                <p class="d-none d-sm-block">Resolved</p>
                                            </div>
                                        </a>
                                        <ng-template ngbNavContent>
                                            <div class="ps" [perfectScrollbar]>
                                                <p class="text-muted mb-1">Resolved Chats</p>
                                                <ul class="list-unstyled chat-list px-1">
                                                    <li class="chat-item pr-1"
                                                        *ngFor="let conversation of historyconversations">
                                                        <a (click)="selectChat(conversation)"
                                                            class="d-flex align-items-center">
                                                            <figure class="mb-0 mr-2">
                                                                <img [src]="sanitizeimage(conversation.profile_pic)"
                                                                    class="img-xs rounded-circle" alt="user">
                                                                <div class="status online"></div>
                                                            </figure>
                                                            <div
                                                                class="d-flex justify-content-between flex-grow border-bottom">
                                                                <div>
                                                                    <p class="text-body font-weight-bold">
                                                                        {{conversation.user_name}}</p>
                                                                    <div class="d-flex align-items-center"
                                                                        *ngIf="conversation.is_image">
                                                                        <i
                                                                            class="feather icon-image text-muted icon-sm mb-2px"></i>
                                                                        <p class="text-muted ml-1">Photo</p>
                                                                    </div>
                                                                    <p class="text-muted tx-13"
                                                                        *ngIf="!conversation.is_image">
                                                                        {{msgdisp(conversation.last_message)}}</p>
                                                                </div>
                                                                <div class="d-flex flex-column align-items-end">
                                                                    <p class="text-muted tx-13 mb-1">
                                                                        {{chattime(conversation.last_message_time)}}</p>
                                                                    <!-- UNREAD MESSAGE COUNT -->
                                                                    <!-- <div class="badge badge-pill badge-primary ml-auto">
                                                                        5</div> -->
                                                                </div>
                                                            </div>
                                                        </a>
                                                    </li>
                                                </ul>
                                            </div>
                                        </ng-template>
                                    </li> <!-- End contacts tab-->
                                </ul>
                                <div [ngbNavOutlet]="defaultNav" class="mt-3"></div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-8 chat-content">
                        <div class="chat-header border-bottom pb-2">
                            <div class="d-flex justify-content-between">
                                <div class="d-flex align-items-center">
                                    <i (click)="backToChatList()"
                                        class="feather icon-corner-up-left icon-md mr-2 ml-n2 text-muted d-lg-none"></i>
                                    <figure class="mb-0 mr-2" *ngIf="isConvSelected">
                                        <img [src]="sanitizeimage(currentConversation.profile_pic)"
                                            class="img-sm rounded-circle" alt="image">
                                        <div class="status online"></div>
                                        <div class="status online"></div>
                                    </figure>
                                    <div>
                                        <p>{{currentConversation.user_name}}</p>
                                        <!-- <p class="text-muted tx-13">Front-end Developer</p> -->
                                        <p *ngIf="isConvSelected && hastyping(currentConversation._id)"
                                            class="text-success font-weight-medium tx-13">typing...</p>
                                    </div>
                                </div>
                                <div class="d-flex align-items-center mr-n1">
                                    <!-- <a (click)="sendqueue()">
                                        <i class="feather icon-video icon-md text-muted mr-3"
                                            ngbTooltip="Start video call"></i>
                                    </a> -->
                                    <!-- <a href="" (click)="false">
                                        <i class="feather icon-phone-call icon-md text-muted mr-0 mr-sm-3"
                                            ngbTooltip="Start voice call"></i>
                                    </a> -->
                                    <!-- <a (click)="resolveChat()" class="d-none d-sm-block">
                                        <i class="feather icon-x icon-md text-muted"
                                            ngbTooltip="Resolve Chat"></i>
                                    </a>  -->
                                    <button
                                        *ngIf="isConvSelected && !currentConversation.is_ended && !currentConversation.is_acknowledged"
                                        (click)="acceptChat()" class="btn btn-icon btn-info mr-2"
                                        ngbTooltip="Acknowledge this Query">
                                        Acknowledge
                                    </button>
                                    <button
                                        *ngIf="isConvSelected && !currentConversation.is_ended && currentConversation.is_acknowledged"
                                        (click)="resolveChat()" class="btn btn-icon btn-success"
                                        ngbTooltip="Resolve this query">
                                        Resolve
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="chat-body" #messageContainer [perfectScrollbar]="config" (wheel)="onScroll()">
                            <ul class="messages">
                                <!-- <li class="message-item friend">
                                    <img src="https://via.placeholder.com/37x37" class="img-xs rounded-circle"
                                        alt="avatar">
                                    <div class="content">
                                        <div class="message">
                                            <div class="bubble">
                                                <p>Lorem Ipsum is simply dummy text of the printing and typesetting
                                                    industry.</p>
                                            </div>
                                            <span>8:12 PM</span>
                                        </div>
                                    </div>
                                </li> -->
                                <li *ngFor="let msg of message_history" class="message-item"
                                    [ngClass]="msg.isUser_Msg ? 'friend' : 'me'">
                                    <!-- <img src="https://via.placeholder.com/37x37" class="img-xs rounded-circle"
                                        alt="avatar"> -->
                                    <div class="content">
                                        <!-- <div class="message">
                                            <div class="bubble">
                                                <p>Lorem Ipsum is simply dummy text of the printing and typesetting
                                                    industry printing and typesetting industry.</p>
                                            </div>
                                        </div> -->
                                        <div class="message">
                                            <div class="bubble">
                                                <p *ngIf="msg.msg_type=='text'" [innerHTML]="linkify(msg.message)"></p>
                                                <img (click)="openimage(msg.message,imageopenModal)" class="image-msg"
                                                    *ngIf="msg.msg_type=='image'" [src]="sanitizeimage(msg.message)"
                                                    alt="Image">
                                            </div>
                                            <span>{{msgtime(msg.time)}}</span>
                                        </div>
                                    </div>
                                </li>
                            </ul>
                        </div>
                        <emoji-mart class="emoji-mart" [showPreview]="false" [enableFrequentEmojiSort]="true"
                            [style]="{ width: '100%', position: 'absolute', bottom: '40px', overflow: 'hidden', height: '250px' }"
                            *ngIf="isEmojiPickerVisible" (emojiSelect)="addEmoji($event)" title="Choose your emoji">
                        </emoji-mart>
                        <div class="chat-footer d-flex"
                            *ngIf="isConvSelected && !currentConversation.is_ended && currentConversation.is_acknowledged">
                            <div>
                                <button type="button" class="btn border btn-icon rounded-circle mr-2" ngbTooltip="Emoji"
                                    (click)="isEmojiPickerVisible = !isEmojiPickerVisible;">
                                    <i class="feather icon-smile text-muted"></i>
                                </button>
                            </div>
                            <div class="d-none d-md-block">
                                <button (click)="uploadimage()" type="button"
                                    class="btn border btn-icon rounded-circle mr-2" ngbTooltip="Attatch Image">
                                    <i class="feather icon-paperclip text-muted"></i>
                                </button>
                            </div>
                            <!-- <div class="d-none d-md-block">
                                <button type="button" class="btn border btn-icon rounded-circle mr-2"
                                    ngbTooltip="Record you voice">
                                    <i class="feather icon-mic text-muted"></i>
                                </button>
                            </div> -->
                            <form class="search-form flex-grow mr-2">
                                <div class="input-group">
                                    <input #msg="ngModel" [(ngModel)]="msgdata" name="msg" autocomplete="off" required
                                        type="text" (keydown)="typing_keydown()" (keyup)="typing_keyup()"
                                        (keyup.enter)="sendmsg()" class="form-control rounded-pill" id="chatForm"
                                        placeholder="Type a message">
                                </div>
                            </form>
                            <div>
                                <button (click)="sendmsg()" type="button"
                                    class="btn btn-primary btn-icon rounded-circle">
                                    <i class="feather icon-send"></i>
                                </button>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<ng-template #imageopenModal let-modal>
    <div class="modal-body">
        <img [src]="imagepreview" style="max-height:calc(100vh - 150px);max-width: 100%;">
        <button type="button" class="close" (click)="modal.close('close')" aria-label="Close">
            <span aria-hidden="true">&times;</span>
        </button>
    </div>
</ng-template>